# 二维码签到系统 - 完整部署文档

## 📋 文档概述

本文档提供二维码签到系统的完整部署、配置和使用指南。系统为三个企业（汇博劳务公司、恒信劳务公司、临时工）提供独立的二维码签到解决方案。

## 🎯 系统特性

### 核心功能
- ✅ **企业隔离** - 每个企业独立的数据表和表单
- ✅ **自动时间记录** - 自动记录签到/签退时间
- ✅ **智能Hook逻辑** - 自动设置公司信息和工作时间计算
- ✅ **表单验证** - 姓名、手机号格式验证
- ✅ **二维码访问** - 支持移动端扫码使用

### 技术优势
- 🚀 **快速部署** - 一键部署脚本
- 🔧 **易于维护** - 模块化脚本设计
- 📊 **数据隔离** - 企业间数据完全独立
- 🔒 **安全可靠** - 基于现有低代码平台

## 🏗️ 系统架构

### 数据表结构
| 企业 | 数据表 | 描述 |
|------|--------|------|
| 汇博劳务公司 | `huibo_labor_sign_records` | 汇博签到记录 |
| 恒信劳务公司 | `hengxin_labor_sign_records` | 恒信签到记录 |
| 临时工 | `temporary_labor_sign_records` | 临时工签到记录 |

### 表单系统
每个企业包含两个专用表单：

#### 汇博劳务公司
- **签到表单**: `huibo_qr_checkin`
- **签退表单**: `huibo_qr_checkout`

#### 恒信劳务公司
- **签到表单**: `hengxin_qr_checkin`
- **签退表单**: `hengxin_qr_checkout`

#### 临时工
- **签到表单**: `temporary_qr_checkin`
- **签退表单**: `temporary_qr_checkout`

### Hook智能逻辑
- **签到Hook**: 自动设置签到时间和公司信息
- **签退Hook**: 自动设置签退时间和公司信息，计算工作时间

## 🚀 快速部署指南

### 环境要求
- ✅ Node.js 16+ 
- ✅ 低代码Excel系统运行在端口3000
- ✅ 网络连接正常

### 部署步骤

#### 1. 检查服务器状态
```bash
# 检查服务器健康状态
curl http://localhost:3000/health

# 预期输出
{"status":"ok","timestamp":"...","database":"connected","environment":"development"}
```

#### 2. 执行快速部署（推荐）
```bash
# 进入项目目录
cd /Users/chenzhihan/Desktop/lowCode_excel

# 执行简化版部署脚本
node @checkinSystem/scripts/创建二维码签到系统简化版.js
```

#### 3. 验证部署结果
```bash
# 测试系统功能
node @checkinSystem/scripts/测试新二维码签到系统.js
```

### 完整部署选项

#### 完整功能部署
```bash
# 使用完整版脚本（包含数据表创建）
node @checkinSystem/scripts/创建二维码签到系统完整版.js
```

#### API方式部署
```bash
# 使用API创建系统
node @checkinSystem/scripts/使用API创建二维码签到系统.js
```

## 🔗 二维码访问地址

### 汇博劳务公司
- **签到二维码**: `http://localhost:3000/api/public/form/forms/huibo_qr_checkin`
- **签退二维码**: `http://localhost:3000/api/public/form/forms/huibo_qr_checkout`

### 恒信劳务公司
- **签到二维码**: `http://localhost:3000/api/public/form/forms/hengxin_qr_checkin`
- **签退二维码**: `http://localhost:3000/api/public/form/forms/hengxin_qr_checkout`

### 临时工
- **签到二维码**: `http://localhost:3000/api/public/form/forms/temporary_qr_checkin`
- **签退二维码**: `http://localhost:3000/api/public/form/forms/temporary_qr_checkout`

## 📱 二维码生成指南

### 推荐工具
- **草料二维码** (cli.im)
- **QR Code Generator** (qrcode-generator.com)
- **微信小程序二维码生成**

### 生成步骤
1. 复制上述URL地址
2. 使用二维码生成工具
3. 设置合适的尺寸（建议10×10cm）
4. 下载并打印二维码

### 放置建议
- 🏢 **企业入口处** - 方便员工签到
- 📍 **办公区域** - 便于签退
- 📋 **备用方案** - 准备纸质签到表

## 👥 使用流程

### 员工操作流程

#### 签到流程
1. 扫描企业签到二维码
2. 填写姓名和手机号
3. 提交表单
4. 系统自动记录签到时间和公司信息

#### 签退流程
1. 扫描企业签退二维码
2. 填写姓名和手机号
3. 提交表单
4. 系统自动记录签退时间并计算工作时间

### 管理员操作流程

#### 数据查询
```bash
# 查询表单列表
curl http://localhost:3000/api/forms

# 查询数据表映射
curl http://localhost:3000/api/mappings
```

#### 数据管理
- 通过数据浏览器查看签到记录
- 导出Excel格式报表
- 监控系统运行状态

## 🛠️ 脚本说明

### 主要部署脚本

| 脚本文件 | 功能 | 推荐场景 |
|----------|------|----------|
| `创建二维码签到系统简化版.js` | 快速部署，基于现有数据表 | ✅ 推荐使用 |
| `创建二维码签到系统完整版.js` | 完整功能部署 | 需要完整功能 |
| `使用API创建二维码签到系统.js` | API方式创建 | 自动化部署 |

### 测试和维护脚本

| 脚本文件 | 功能 | 使用场景 |
|----------|------|----------|
| `测试新二维码签到系统.js` | 完整系统测试 | 部署后验证 |
| `完整系统测试.js` | 系统功能测试 | 定期检查 |
| `测试数据表创建API.js` | API功能测试 | 开发测试 |
| `远程签到系统部署脚本.js` | 远程服务器部署 | 生产环境 |

### 工具脚本

| 脚本文件 | 功能 | 使用场景 |
|----------|------|----------|
| `检查并创建数据表.js` | 数据表检查创建 | 数据表管理 |
| `通过表单创建数据表.js` | 表单数据表创建 | 表单扩展 |

## 🔧 配置说明

### 表单字段配置

#### 基本信息字段
- **姓名** (text, 必填)
- **手机号** (text, 必填，格式验证)
- **所在公司** (select, 必填，自动设置)

#### 时间字段
- **签到时间** (datetime, 自动记录)
- **签退时间** (datetime, 自动记录)
- **实际工作时间** (number, 自动计算)

### Hook配置

#### 签到Hook
```javascript
// 自动设置签到时间和公司信息
formData.sign_in_time = new Date().toISOString();
formData.company = "huibo"; // 根据表单ID自动设置
```

#### 签退Hook
```javascript
// 自动设置签退时间和计算工作时间
formData.sign_out_time = new Date().toISOString();
// 计算工作时间逻辑...
```

## 🚨 故障排除

### 常见问题及解决方案

#### 1. 服务器连接失败
```bash
# 检查服务器状态
curl http://localhost:3000/health

# 检查端口占用
lsof -i :3000

# 重启服务器
cd backend && npm start
```

#### 2. 部署脚本执行失败
```bash
# 检查Node.js版本
node --version

# 安装依赖
npm install axios

# 检查脚本权限
chmod +x @checkinSystem/scripts/*.js
```

#### 3. 表单提交失败
```bash
# 测试表单提交
curl -X POST http://localhost:3000/api/public/form/forms/huibo_qr_checkin/submit \
  -H "Content-Type: application/json" \
  -d '{"data": {"name": "测试用户", "phone": "13800138000"}}'
```

#### 4. Hook功能异常
- 检查Hook配置是否正确创建
- 查看服务器日志获取详细错误
- 重新执行Hook修复脚本

### 日志检查

#### 服务器日志
```bash
# 查看应用日志
tail -f backend/logs/app.log

# 查看错误日志
tail -f backend/logs/error.log
```

#### 脚本执行日志
- 部署脚本会输出详细执行日志
- 关注错误信息和警告信息
- 记录执行时间戳

## 📊 监控和维护

### 日常监控

#### 系统健康检查
```bash
# 定期检查系统状态
curl http://localhost:3000/health

# 检查表单访问
curl http://localhost:3000/api/forms
```

#### 数据完整性检查
- 定期检查各企业签到记录
- 验证时间记录准确性
- 检查数据表完整性

### 定期维护

#### 数据备份
```bash
# 导出签到数据
curl http://localhost:3000/api/data/huibo_labor_sign_records > backup/huibo_data.json

# 备份表单配置
curl http://localhost:3000/api/forms > backup/forms_backup.json
```

#### 系统清理
```bash
# 清理过期数据（如果需要）
node clear/cleanup-auto.js
```

### 性能优化建议
- 监控服务器内存使用
- 优化数据库查询
- 定期清理日志文件
- 更新系统依赖

## 🔄 更新和升级

### 版本更新

#### 脚本更新
```bash
# 拉取最新代码
git pull origin main

# 重新部署系统
node @checkinSystem/scripts/创建二维码签到系统简化版.js
```

#### 配置更新
- 更新表单字段定义
- 优化Hook逻辑
- 调整验证规则

### 功能扩展

#### 添加新企业
1. 创建新的数据表
2. 添加企业表单定义
3. 配置对应的Hook逻辑
4. 生成新的二维码

#### 自定义字段
1. 修改表单定义
2. 更新数据表结构
3. 调整Hook逻辑
4. 重新部署系统

## 📞 技术支持

### 问题诊断流程

1. **检查基础连接**
   ```bash
   curl http://localhost:3000/health
   ```

2. **验证表单访问**
   ```bash
   curl http://localhost:3000/api/forms
   ```

3. **测试功能完整性**
   ```bash
   node @checkinSystem/scripts/测试新二维码签到系统.js
   ```

4. **查看详细日志**
   - 服务器应用日志
   - 脚本执行日志
   - 浏览器控制台日志

### 紧急恢复措施

#### 系统重建
```bash
# 清理现有系统
node clear/cleanup-auto.js

# 重新部署
node @checkinSystem/scripts/创建二维码签到系统简化版.js
```

#### 数据恢复
- 从备份文件恢复数据
- 重新创建表单配置
- 验证系统功能

## 📋 附录

### 脚本文件清单

#### 保留的新版本脚本
- `测试数据表创建API.js`
- `测试新二维码签到系统.js`
- `创建二维码签到系统简化版.js`
- `创建二维码签到系统完整版.js`
- `检查并创建数据表.js`
- `使用API创建二维码签到系统.js`
- `通过表单创建数据表.js`
- `完整系统测试.js`
- `远程签到系统部署脚本.js`

#### 已清理的老版本脚本
- `测试二维码签到系统.js` ❌ 已清理
- `创建企业二维码签到系统.js` ❌ 已清理
- `创建全新二维码签到系统.js` ❌ 已清理
- `修复二维码签到系统Hook.js` ❌ 已清理
- `清理并重新创建Hook.js` ❌ 已清理
- `配置签到表字段.js` ❌ 已清理
- `签到系统增强脚本.js` ❌ 已清理
- `修复Hook配置.js` ❌ 已清理
- `自动获取签到表哈希值.js` ❌ 已清理

### API接口参考

#### 表单管理API
- `GET /api/forms` - 获取表单列表
- `GET /api/forms/{formId}` - 获取表单详情
- `POST /api/forms` - 创建表单
- `DELETE /api/forms/{formId}` - 删除表单

#### 数据查询API
- `GET /api/data/{tableName}` - 查询数据表
- `GET /api/mappings` - 获取数据表映射

#### 公开表单API
- `GET /api/public/form/forms/{formId}` - 获取公开表单
- `POST /api/public/form/forms/{formId}/submit` - 提交表单数据

### 技术规格

#### 系统要求
- **Node.js**: 16.0+
- **数据库**: SQLite/MySQL
- **内存**: 最低1GB，推荐2GB
- **存储**: 最低100MB可用空间

#### 性能指标
- **响应时间**: < 500ms
- **并发用户**: 支持50+同时在线
- **数据存储**: 支持10万+记录

---
**文档版本**: v2.0  
**最后更新**: 2025-11-20  
**系统状态**: ✅ 正常运行  
**部署状态**: ✅ 已验证通过

> 💡 **提示**: 本文档会根据系统更新定期维护，建议定期查看最新版本。
