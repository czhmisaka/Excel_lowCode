# 大文件上传功能使用说明

## 概述

本系统现已支持1000MB以上的Excel文件上传，通过流式处理和内存监控技术，确保大文件处理过程中的稳定性和性能。

## 新功能特性

### 1. 智能文件处理
- **小文件（<50MB）**：使用原有快速处理方式
- **大文件（≥50MB）**：使用流式处理方式，避免内存溢出

### 2. 流式处理技术
- 文件分块读取，避免一次性加载到内存
- 数据分批插入数据库，避免大事务锁表
- 实时内存监控，自动暂停处理防止内存溢出

### 3. 进度跟踪
- 实时显示处理进度
- 支持进度查询API
- 详细的处理状态信息

### 4. 内存管理
- 自动内存使用监控
- 临界值自动暂停处理
- 强制垃圾回收机制

## API接口

### 1. 智能上传（推荐）
```http
POST /api/upload/smart
Content-Type: multipart/form-data

file: <Excel文件>
```

**特点**：自动根据文件大小选择处理方式

### 2. 大文件上传
```http
POST /api/upload/large
Content-Type: multipart/form-data

file: <Excel文件>
```

**特点**：强制使用大文件处理方式，适合已知的大文件

### 3. 进度查询
```http
GET /api/upload/progress/{progressId}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "status": "inserting_data",
    "processedRows": 15000,
    "totalRows": 50000,
    "currentBatch": 30,
    "message": "正在插入数据... (15000/50000)"
  }
}
```

## 状态说明

| 状态             | 说明             |
| ---------------- | ---------------- |
| `initializing`   | 初始化中         |
| `reading_file`   | 读取文件         |
| `creating_table` | 创建数据库表     |
| `inserting_data` | 插入数据中       |
| `paused`         | 内存过高暂停处理 |
| `warning`        | 部分批次处理失败 |
| `completed`      | 处理完成         |
| `error`          | 处理失败         |

## 性能优化建议

### 1. 服务器配置
- **内存**：建议至少4GB RAM
- **Node.js参数**：使用 `--max-old-space-size=4096` 增加堆内存限制
- **数据库**：确保有足够的连接数和缓冲区

### 2. 文件优化
- 移除不必要的列和行
- 压缩Excel文件
- 避免使用复杂的公式和格式

### 3. 网络优化
- 使用稳定的网络连接
- 考虑分片上传（未来版本支持）

## 错误处理

### 常见错误及解决方案

1. **内存不足错误**
   - 原因：文件过大或服务器内存不足
   - 解决方案：增加服务器内存或使用 `--max-old-space-size` 参数

2. **处理超时**
   - 原因：文件过大处理时间过长
   - 解决方案：使用进度跟踪功能，支持断点续传（未来版本）

3. **数据库连接错误**
   - 原因：连接数不足或超时
   - 解决方案：优化数据库配置，增加连接超时时间

## 使用示例

### 前端调用示例
```javascript
// 使用智能上传
const formData = new FormData();
formData.append('file', excelFile);

const response = await fetch('/api/upload/smart', {
  method: 'POST',
  body: formData
});

const result = await response.json();

if (result.success) {
  console.log('上传成功:', result.data);
} else {
  console.error('上传失败:', result.message);
}
```

### 进度监控示例
```javascript
// 假设从响应中获取了progressId
const progressId = result.data.progressId;

// 定期查询进度
const checkProgress = async () => {
  const progressResponse = await fetch(`/api/upload/progress/${progressId}`);
  const progressData = await progressResponse.json();
  
  if (progressData.success) {
    const progress = progressData.data;
    console.log(`进度: ${progress.processedRows}/${progress.totalRows} - ${progress.message}`);
    
    if (progress.status === 'completed' || progress.status === 'error') {
      clearInterval(progressInterval);
    }
  }
};

const progressInterval = setInterval(checkProgress, 2000);
```

## 技术架构

### 核心组件
1. **StreamExcelParser** - 流式Excel解析器
2. **MemoryMonitor** - 内存监控工具
3. **LargeFileUploadController** - 大文件上传控制器
4. **进度跟踪系统** - 实时进度监控

### 处理流程
1. 文件上传到临时目录
2. 解析Excel文件结构
3. 创建数据库表
4. 分批读取和处理数据
5. 实时监控内存使用
6. 清理临时文件

## 注意事项

1. **临时文件**：处理完成后会自动清理临时文件
2. **内存使用**：系统会自动监控和优化内存使用
3. **进度信息**：进度信息在服务器重启后会丢失
4. **文件格式**：仅支持 .xlsx 和 .xls 格式

## 未来规划

- [ ] 分片上传支持
- [ ] 断点续传功能
- [ ] 并行处理优化
- [ ] 更详细的内存分析报告
- [ ] 前端进度条组件

---

**版本**: 1.0  
**更新日期**: 2025-10-17  
**技术支持**: 如有问题请联系系统管理员
