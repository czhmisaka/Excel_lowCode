# Excel数据管理服务器 - 查询接口压力测试

## 概述

这是一个专门为Excel数据管理服务器设计的查询接口压力测试工具，用于测试数据查询接口的性能和稳定性。

## 功能特性

- ✅ **多种查询模式**：简单查询、复杂查询、分页查询、混合查询
- ✅ **并发测试**：支持多线程并发请求
- ✅ **详细统计**：响应时间、成功率、吞吐量等性能指标
- ✅ **错误分析**：详细的错误分类和统计
- ✅ **实时进度**：测试过程中实时显示进度和成功率
- ✅ **MCP认证**：使用MCP服务器特殊认证方式，避免权限问题

## 测试目标

- **目标接口**: `GET /api/data/{hash}`
- **测试表**: 年假余额表 (哈希: `25295650f0cc6d4c6a18c39e77245406`)
- **表结构**: 
  - 部门 (string)
  - 姓名 (string)
  - 员工编号 (number)
  - 当前剩余年休假_天 (string)

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 交互式模式

```bash
cd apiSpeedTest
python api_speed_test.py
```

然后选择测试模式：
- 1: 测试单个请求
- 2: 并发压力测试
- 3: 全面压力测试

### 2. 命令行模式

```bash
# 测试单个请求
python api_speed_test.py single

# 并发压力测试
python api_speed_test.py concurrent [并发数] [总请求数] [查询类型]

# 全面压力测试
python api_speed_test.py comprehensive
```

**参数说明**:
- `并发数`: 并发线程数 (默认: 10)
- `总请求数`: 总请求次数 (默认: 100)
- `查询类型`: 
  - `simple`: 简单查询 (单字段模糊搜索)
  - `complex`: 复杂查询 (多字段联合搜索)
  - `pagination`: 分页查询
  - `mixed`: 混合查询 (默认)

### 3. 示例命令

```bash
# 简单测试
python api_speed_test.py single

# 并发测试 - 10个线程，100个请求，简单查询
python api_speed_test.py concurrent 10 100 simple

# 并发测试 - 50个线程，500个请求，混合查询
python api_speed_test.py concurrent 50 500 mixed

# 全面测试 - 运行所有测试场景
python api_speed_test.py comprehensive
```

## 测试报告内容

测试完成后会生成详细的报告，包括：

### 基本统计
- 成功/失败请求数
- 成功率
- 总测试时间
- 平均吞吐量

### 响应时间分析
- 平均响应时间
- 最快/最慢响应时间
- 响应时间标准差
- 响应时间分布 (0-100ms, 100-500ms, 500ms-1s, 1-3s, >3s)

### 查询类型分布
- 各种查询类型的请求次数和比例

### 错误详情
- 错误类型统计
- 每种错误的出现次数和比例

## 认证方式

测试脚本使用MCP服务器特殊认证方式：
```python
headers = {
    "x-special-auth": "czhmisakaLogin:aGithubUserFuckEverything"
}
```

这种方式会自动获得管理员权限，无需手动登录获取token。

## 测试场景说明

### 1. 简单查询
- 单字段模糊搜索
- 随机选择部门、姓名、员工编号、年假天数进行查询

### 2. 复杂查询
- 多字段联合搜索 ($or条件)
- 随机选择2-3个字段进行联合查询

### 3. 分页查询
- 随机分页大小 (10, 20, 50, 100)
- 随机页码 (1-10)
- 结合简单或复杂查询条件

### 4. 混合查询
- 随机选择所有查询类型
- 模拟真实使用场景

## 性能指标参考

- **优秀**: 平均响应时间 < 100ms，成功率 > 99%
- **良好**: 平均响应时间 < 500ms，成功率 > 95%
- **一般**: 平均响应时间 < 1s，成功率 > 90%
- **需要优化**: 平均响应时间 > 1s，成功率 < 90%

## 注意事项

1. **确保后端服务运行**: 测试前请确保后端服务在端口3000正常运行
2. **网络环境**: 测试结果受网络环境影响，建议在稳定的网络环境下测试
3. **数据库负载**: 大量并发查询可能会对数据库造成压力
4. **超时设置**: 默认超时时间为120秒，可根据需要调整

## 故障排除

如果测试失败，请检查：

1. 后端服务是否正常运行
2. 网络连接是否正常
3. 数据库连接是否正常
4. 认证头是否正确配置

## 连接测试工具

除了压力测试脚本外，还提供了一个连接测试工具，用于验证服务器连接状态：

```bash
# 测试本地服务器
python test_connection.py local

# 测试远程服务器
python test_connection.py remote

# 交互式模式
python test_connection.py
```

## 配置文件

所有配置都在 `config.py` 文件中管理：

- **服务器配置**: 支持本地、远程、生产环境
- **测试参数**: 超时时间、并发数、默认值等
- **性能阈值**: 优秀、良好、一般、需要优化的标准

## 扩展使用

### 1. 测试其他数据表

修改 `config.py` 中的目标哈希值：

```python
TARGET_HASH = "其他表的哈希值"
```

### 2. 添加新的服务器配置

在 `config.py` 中添加新的服务器：

```python
SERVERS = {
    # ... 现有配置
    "custom": {
        "base_url": "http://your-server.com:port",
        "description": "自定义服务器"
    }
}
```

### 3. 调整测试参数

修改测试配置：

```python
TEST_CONFIG = {
    "timeout": 60,  # 减少超时时间
    "max_workers": 50,  # 减少最大并发数
    # ... 其他参数
}
```

## 故障排除

### 常见问题

1. **连接被拒绝**
   - 检查后端服务是否运行
   - 确认服务器地址和端口正确
   - 使用 `test_connection.py` 验证连接

2. **认证失败**
   - 确认 MCP 认证头正确
   - 检查后端认证中间件配置

3. **查询超时**
   - 增加 `timeout` 配置
   - 检查网络连接和服务器负载

### 调试技巧

1. 先运行连接测试验证基本功能
2. 从单个请求测试开始
3. 逐步增加并发数和请求数
4. 观察服务器日志了解详细错误

## 版本信息

- 版本: 1.1.0
- 创建时间: 2025-11-23
- 更新内容: 添加配置文件、连接测试工具
- 适用环境: Python 3.6+
