# 年假计算系统 - 数据备份与恢复说明

本文档详细说明如何使用 `exportData.sh` 和 `importData.sh` 脚本来备份和恢复年假计算系统的所有数据和配置。

## 概述

这两个脚本提供了完整的系统迁移解决方案，支持：

- **数据库数据**：员工信息、年假记录、请假记录、表映射配置
- **文件数据**：上传的文件（通过Docker卷或本地目录）
- **配置数据**：环境变量、Docker配置、数据库初始化脚本
- **Docker镜像**：前端和后端应用镜像

## 系统要求

- Docker 和 Docker Compose
- MySQL 客户端工具 (mysql, mysqldump)
- Bash shell 环境

## 导出数据 (exportData.sh)

### 基本用法

```bash
# 导出所有数据并压缩
./exportData.sh

# 导出所有数据但不压缩
./exportData.sh --no-compress

# 仅导出数据库数据
./exportData.sh --database-only

# 仅导出文件数据
./exportData.sh --files-only

# 仅导出配置数据
./exportData.sh --configs-only

# 仅导出Docker镜像
./exportData.sh --images-only
```

### 导出内容

脚本会在 `exports/` 目录下创建备份文件，命名格式为：
```
exports/annual-leave-backup-YYYYMMDD-HHMMSS-git_hash.tar.gz
```

每个备份包包含：
- `database/` - 数据库结构和数据
- `files/` - 上传的文件数据
- `configs/` - 配置文件
- `images/` - Docker镜像
- `metadata.json` - 备份元数据

### 环境变量配置

可以在 `.env` 或 `docker/.env` 文件中配置导出参数：

```bash
# 导出目录
EXPORT_DIR=./exports

# 是否压缩数据包
COMPRESS_DATA=true

# 数据库连接配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=annual_leave
DB_USER=annual_user
DB_PASSWORD=annual_password
```

## 导入数据 (importData.sh)

### 基本用法

```bash
# 导入最新的备份包
./importData.sh

# 导入指定的备份包
./importData.sh exports/annual-leave-backup-20250101-120000-abc123.tar.gz

# 导入并覆盖现有配置文件
./importData.sh --overwrite exports/annual-leave-backup-20250101-120000-abc123.tar.gz

# 导入但不自动启动服务
./importData.sh --no-start exports/annual-leave-backup-20250101-120000-abc123.tar.gz

# 仅导入数据库数据
./importData.sh --database-only exports/annual-leave-backup-20250101-120000-abc123.tar.gz

# 仅导入文件数据
./importData.sh --files-only exports/annual-leave-backup-20250101-120000-abc123.tar.gz

# 仅导入配置数据
./importData.sh --configs-only exports/annual-leave-backup-20250101-120000-abc123.tar.gz

# 仅导入Docker镜像
./importData.sh --images-only exports/annual-leave-backup-20250101-120000-abc123.tar.gz
```

### 导入流程

1. **验证导入包**：检查备份包的完整性和有效性
2. **停止服务**：停止当前运行的Docker服务
3. **导入数据**：按顺序导入数据库、文件、配置和镜像
4. **启动服务**：重新启动Docker服务
5. **清理临时文件**：删除解压的临时文件

### 导入注意事项

- **数据库连接**：确保目标环境的数据库配置正确
- **配置文件覆盖**：使用 `--overwrite` 选项覆盖现有配置文件
- **服务启动**：使用 `--no-start` 选项手动控制服务启动时机

## 使用场景

### 1. 系统迁移

```bash
# 在源服务器上导出数据
./exportData.sh

# 将备份文件传输到目标服务器
scp exports/annual-leave-backup-*.tar.gz user@new-server:/path/to/project/

# 在目标服务器上导入数据
./importData.sh exports/annual-leave-backup-*.tar.gz
```

### 2. 定期备份

```bash
# 创建每日备份（可加入cron任务）
./exportData.sh

# 保留最近7天的备份
find exports/ -name "annual-leave-backup-*.tar.gz" -mtime +7 -delete
```

### 3. 数据恢复

```bash
# 恢复到特定时间点的备份
./importData.sh exports/annual-leave-backup-20250101-120000-abc123.tar.gz
```

### 4. 开发环境同步

```bash
# 从生产环境导出数据
./exportData.sh --database-only

# 在开发环境导入数据
./importData.sh --database-only exports/annual-leave-backup-*.tar.gz
```

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查数据库服务是否运行
   - 验证数据库连接配置
   - 确保数据库用户有足够权限

2. **Docker卷不存在**
   - 脚本会自动创建必要的Docker卷
   - 手动创建：`docker volume create backend-uploads`

3. **权限问题**
   - 确保脚本有执行权限：`chmod +x exportData.sh importData.sh`
   - 确保对导出目录有写权限

4. **依赖缺失**
   - 安装MySQL客户端：`apt-get install mysql-client` (Ubuntu) 或 `brew install mysql-client` (macOS)
   - 确保Docker和Docker Compose已安装

### 日志和调试

- 脚本会输出详细的彩色日志信息
- 使用 `set -x` 在脚本开头启用调试模式
- 检查生成的元数据文件了解备份详情

## 最佳实践

1. **定期备份**：建议每周执行一次完整备份
2. **测试恢复**：定期测试备份文件的恢复功能
3. **安全存储**：将备份文件存储在安全的位置
4. **版本控制**：保留多个时间点的备份
5. **监控空间**：监控导出目录的磁盘空间使用情况

## 相关脚本

- `docker/export-images.sh` - 仅导出Docker镜像
- `docker/import-images.sh` - 仅导入Docker镜像
- `run.sh` - 完整的构建和部署流程

## 技术支持

如遇到问题，请检查：
1. 系统依赖是否满足
2. 环境变量配置是否正确
3. 数据库连接是否正常
4. Docker服务是否运行正常
