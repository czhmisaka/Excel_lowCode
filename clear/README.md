# 低代码Excel系统 - 数据清理工具

这是一个用于清理端口3000上所有数据表、表单和hook的脚本工具。基于现有API接口，无需修改项目代码。

## 功能特性

- ✅ **安全清理** - 基于现有API接口，不修改项目代码
- ✅ **批量操作** - 自动批量删除所有表单和数据表
- ✅ **进度显示** - 实时显示清理进度和结果
- ✅ **错误处理** - 处理API调用失败的情况
- ✅ **验证功能** - 清理完成后验证所有资源是否已删除
- ✅ **交互确认** - 提供多次确认，防止误操作

## 清理范围

该脚本会清理以下所有资源：

1. **表单定义** - 所有表单配置
2. **Hook配置** - 表单关联的所有hook
3. **提交记录** - 表单的提交数据
4. **数据表映射** - Excel文件与动态表的映射关系
5. **数据表** - 动态生成的数据库表

## 使用前提

1. 后端服务运行在端口3000
2. Node.js环境可用
3. 网络连接正常

## 快速开始

### 方法1：直接运行（推荐）

```bash
# 进入项目根目录
cd /Users/chenzhihan/Desktop/lowCode_excel

# 运行清理脚本
node clear/cleanup.js
```

### 方法2：安装依赖后运行

```bash
# 安装依赖（如果需要）
cd clear
npm install

# 运行脚本
node cleanup.js
```

## 命令行选项

```bash
# 使用自定义API地址
node clear/cleanup.js --api-base http://localhost:3000/api

# 使用API密钥（如果需要）
node clear/cleanup.js --api-key your-api-key

# 组合使用
node clear/cleanup.js --api-base http://your-server.com/api --api-key your-key

# 显示帮助信息
node clear/cleanup.js --help
```

## 环境变量

```bash
# 设置API基础地址
export API_BASE=http://localhost:3000/api

# 设置API密钥（可选）
export API_KEY=your-api-key

# 运行脚本
node clear/cleanup.js
```

## 使用流程

1. **连接测试** - 脚本首先测试API连接
2. **资源统计** - 显示当前存在的表单和数据表数量
3. **确认操作** - 提供两次确认，防止误删除
4. **批量删除** - 按顺序删除表单和数据表
5. **结果验证** - 验证所有资源是否已成功删除
6. **清理总结** - 显示成功和失败的数量

## 示例输出

```
============================================================
低代码Excel系统 - 数据清理工具
============================================================
[INFO] API地址: http://localhost:3000/api
[INFO] 测试API连接...
[SUCCESS] API连接成功

⚠️  警告: 此操作将删除所有表单、数据表和hook配置！
   删除的数据无法恢复，请谨慎操作！

确认继续清理操作？(y/N): y

📊 资源统计:
  - 表单: 3 个
  - 数据表映射: 2 个

确认删除以上所有资源？(y/N): y

🚀 开始清理...

[INFO] 开始删除 3 个表单...
[INFO] 删除表单: form1
[SUCCESS] 表单 form1 删除成功
...
[SUCCESS] 表单删除完成: 3 成功, 0 失败

[INFO] 开始删除 2 个数据表映射...
[INFO] 删除数据表映射: abc123
[SUCCESS] 数据表映射 abc123 删除成功
...
[SUCCESS] 数据表映射删除完成: 2 成功, 0 失败

🔍 验证清理结果...
[INFO] 验证清理结果...
[SUCCESS] ✅ 清理验证通过: 所有表单和数据表已成功删除

📋 清理总结:
  - 表单删除: 3 成功, 0 失败
  - 数据表删除: 2 成功, 0 失败

🎉 清理完成！所有资源已成功删除
```

## 注意事项

⚠️ **重要警告**:
- 此操作会永久删除所有数据，无法恢复
- 请在测试环境或确认不需要数据时使用
- 建议在执行前备份重要数据
- 脚本提供多次确认，请仔细阅读提示

## 故障排除

### 常见问题

1. **连接失败**
   ```
   [ERROR] API连接失败: connect ECONNREFUSED 127.0.0.1:3000
   ```
   **解决方案**: 确保后端服务运行在端口3000

2. **权限不足**
   ```
   [ERROR] 删除表单失败: 401 Unauthorized
   ```
   **解决方案**: 检查是否需要API密钥，使用 `--api-key` 参数

3. **资源不存在**
   ```
   [WARNING] 表单 xxx 不存在
   ```
   **说明**: 这是正常现象，表示资源已被删除

### 调试模式

如果需要更详细的日志，可以设置环境变量：

```bash
# 启用详细日志
export DEBUG=true
node clear/cleanup.js
```

## API接口说明

脚本使用以下API接口：

- `GET /health` - 健康检查
- `GET /forms` - 获取表单列表
- `DELETE /forms/{formId}` - 删除表单
- `GET /mappings` - 获取数据表映射
- `DELETE /mappings/{hash}` - 删除数据表映射

## 技术支持

如果遇到问题，请检查：
1. 后端服务是否正常运行
2. 网络连接是否正常
3. API地址和密钥是否正确
4. Node.js版本是否兼容

---
*最后更新: 2025-11-19*
