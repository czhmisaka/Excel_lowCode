# Excel_lowCode 服务器端部署指南

## 概述

本指南详细说明如何在远程服务器上部署 Excel_lowCode 应用。您已经导出了 Docker 镜像，现在需要在服务器端进行导入和部署。

## 前置条件

在开始部署前，请确保服务器满足以下要求：

- **操作系统**: Linux (Ubuntu/CentOS 等)
- **Docker**: 已安装 Docker Engine
- **Docker Compose**: 已安装 Docker Compose
- **网络**: 开放所需端口（默认：8080, 3000, 3001）
- **存储**: 至少 1GB 可用磁盘空间

## 第一步：准备部署文件

将以下文件上传到服务器：

1. **镜像文件**（从桌面复制）：
   - `annual-leave-unified_latest-unified-20251029-135143-db48ee1.tar.gz`

2. **部署脚本**（可选，推荐使用）：
   - `docker/import-images.sh`
   - `docker/deploy.sh`
   - `docker/docker-compose.unified.yml`
   - `docker/.env.template`

## 第二步：导入 Docker 镜像

### 方法一：使用导入脚本（推荐）

```bash
# 解压镜像文件（如果需要）
gunzip annual-leave-unified_latest-unified-20251029-135143-db48ee1.tar.gz

# 导入镜像
docker load -i annual-leave-unified_latest-unified-20251029-135143-db48ee1.tar

# 验证导入
docker images | grep annual-leave
```

### 方法二：手动导入

```bash
# 直接导入压缩包
docker load < annual-leave-unified_latest-unified-20251029-135143-db48ee1.tar.gz

# 验证镜像
docker image inspect annual-leave-unified:latest
```

## 第三步：配置环境变量

创建环境配置文件：

```bash
# 复制模板文件
cp .env.template .env

# 编辑配置文件
vim .env
```

关键配置项：

```env
# 数据库配置（推荐使用MySQL）
DB_TYPE=mysql
DB_HOST=localhost
DB_PORT=3306
DB_NAME=annual_leave
DB_USER=root
DB_PASSWORD=your_password

# 或者使用SQLite（简化部署）
DB_TYPE=sqlite
SQLITE_DB_PATH=/app/data/annual_leave.db

# 端口配置
FRONTEND_PORT=8080
BACKEND_PORT=3000
MCP_SERVER_PORT=3001

# 镜像配置
IMAGE_PREFIX=annual-leave
UNIFIED_TAG=latest

# API配置
API_BASE_URL=http://your-server-ip:3000
```

## 第四步：启动服务

### 方法一：使用 Docker Compose（推荐）

```bash
# 使用统一镜像部署
docker-compose -f docker-compose.unified.yml up -d

# 查看服务状态
docker-compose -f docker-compose.unified.yml ps

# 查看日志
docker-compose -f docker-compose.unified.yml logs -f
```

### 方法二：直接运行容器

```bash
# 创建数据卷
docker volume create app-uploads
docker volume create app-data
docker volume create app-exports

# 运行容器
docker run -d \
  --name annual-leave-unified \
  -p 8080:80 \
  -p 3000:3000 \
  -p 3001:3001 \
  -e NODE_ENV=production \
  -e DB_TYPE=sqlite \
  -e SQLITE_DB_PATH=/app/data/annual_leave.db \
  -v app-uploads:/app/uploads \
  -v app-data:/app/data \
  -v app-exports:/app/exports \
  annual-leave-unified:latest
```

## 第五步：验证部署

### 检查服务状态

```bash
# 检查容器运行状态
docker ps

# 检查服务健康状态
curl http://localhost:8080/health
curl http://localhost:3000/health

# 查看容器日志
docker logs annual-leave-unified --tail=50
```

### 访问应用

- **前端界面**: http://your-server-ip:8080
- **后端API**: http://your-server-ip:3000
- **API文档**: http://your-server-ip:3000/api-docs
- **MCP服务**: http://your-server-ip:3001

## 第六步：初始化数据

首次部署后，建议执行以下操作：

1. **创建管理员用户**：
   ```bash
   # 进入容器执行初始化脚本
   docker exec -it annual-leave-unified node scripts/createAdminUser.js
   ```

2. **测试功能**：
   - 访问前端界面
   - 登录系统
   - 测试Excel导入导出功能
   - 验证MCP服务连接

## 常见问题排查

### 1. 端口冲突

如果端口被占用，修改 `.env` 文件中的端口配置：

```env
FRONTEND_PORT=8081
BACKEND_PORT=3002
MCP_SERVER_PORT=3003
```

### 2. 数据库连接失败

检查数据库服务状态和连接配置：

```bash
# 检查MySQL服务
systemctl status mysql

# 检查数据库连接
mysql -h localhost -u root -p
```

### 3. 容器启动失败

查看详细错误信息：

```bash
# 查看容器日志
docker logs annual-leave-unified

# 检查容器状态
docker inspect annual-leave-unified
```

### 4. 文件权限问题

确保数据卷有正确的权限：

```bash
# 检查数据卷权限
docker volume inspect app-uploads
docker volume inspect app-data
```

## 维护操作

### 停止服务

```bash
docker-compose -f docker-compose.unified.yml down
```

### 重启服务

```bash
docker-compose -f docker-compose.unified.yml restart
```

### 更新镜像

```bash
# 停止服务
docker-compose -f docker-compose.unified.yml down

# 导入新镜像
docker load -i new-image.tar

# 启动服务
docker-compose -f docker-compose.unified.yml up -d
```

### 备份数据

```bash
# 备份上传文件
docker run --rm -v app-uploads:/source -v $(pwd):/backup alpine tar czf /backup/uploads-backup-$(date +%Y%m%d).tar.gz -C /source .

# 备份数据库
docker run --rm -v app-data:/source -v $(pwd):/backup alpine tar czf /backup/data-backup-$(date +%Y%m%d).tar.gz -C /source .
```

## 安全建议

1. **修改默认密码**：部署后立即修改数据库和管理员密码
2. **配置防火墙**：只开放必要的端口
3. **使用HTTPS**：在生产环境配置SSL证书
4. **定期备份**：设置自动备份策略
5. **监控日志**：定期检查应用日志

## 技术支持

如果遇到部署问题，请检查：

1. Docker 和 Docker Compose 版本
2. 系统资源（内存、磁盘空间）
3. 网络连接和防火墙设置
4. 查看详细的错误日志

通过以上步骤，您应该能够成功在服务器上部署 Excel_lowCode 应用。
