# 参数系统修复总结

## 问题描述
原 `run.sh` 脚本存在参数解析问题：
- `--mcp-port` 参数被传递给 `docker/deploy.sh`，但后者不支持此参数
- 参数之间存在相互影响和冲突
- 单容器模式不支持 SQLite 数据库和 MCP 服务器

## 修复方案
采用**参数完全正交**的设计原则，所有参数可以任意组合使用。

### 核心修改

#### 1. 增强单容器镜像 (`docker/unified/Dockerfile`)
- 添加 MCP 服务器构建阶段
- 包含前端、后端、MCP 服务器三个服务
- 支持 SQLite 数据库

#### 2. 更新单容器配置 (`docker/docker-compose.unified.yml`)
- 添加 MCP 服务器端口映射：`${MCP_SERVER_PORT}:3001`
- 添加 MCP 服务器环境变量配置
- 添加导出目录卷映射

#### 3. 修复参数处理逻辑 (`run.sh`)
- **参数过滤**：只传递 `docker/deploy.sh` 支持的参数
- **环境变量传递**：端口参数通过环境变量传递
- **参数验证**：添加参数冲突检测

#### 4. 更新部署脚本 (`docker/deploy.sh`)
- 支持 MCP 服务器端口配置
- 更新环境变量处理逻辑
- 完善帮助文档

## 支持的参数组合

### 运行模式参数
- `--run-local`：使用 SQLite 本地数据库
- `--unified`：使用单容器模式部署

### 端口配置参数
- `--backend-port PORT`：后端服务端口（默认: 3000）
- `--frontend-port PORT`：前端服务端口（默认: 8080）  
- `--mcp-port PORT`：MCP 服务器端口（默认: 3001）

### 部署操作参数
- `--backup`：部署前备份数据
- `--restore FILE`：部署后恢复备份
- `--stop-only`：仅停止服务
- `--start-only`：仅启动服务

## 参数组合示例

### 全能单容器模式
```bash
# 单容器 + SQLite + 自定义所有端口
./run.sh --run-local --unified --backend-port 4000 --frontend-port 9000 --mcp-port 9100

# 单容器 + MySQL + 默认端口
./run.sh --unified

# 单容器 + 备份功能
./run.sh --unified --backup
```

### 多容器模式
```bash
# 多容器 + SQLite + MCP服务器
./run.sh --run-local --mcp-port 9200

# 多容器 + MySQL + 默认配置
./run.sh
```

### 自定义端口
```bash
# 仅自定义后端端口
./run.sh --backend-port 5000

# 自定义所有端口
./run.sh --backend-port 4000 --frontend-port 9000 --mcp-port 9100
```

## 技术实现细节

### 参数传递机制
1. **run.sh** 解析所有参数
2. 端口参数通过环境变量传递
3. 部署相关参数传递给 `docker/deploy.sh`
4. 构建相关参数传递给 `docker/build.sh`

### 环境变量优先级
1. 命令行参数（最高优先级）
2. 环境变量文件配置
3. 默认值

### 单容器架构
- **前端**：Nginx (端口 80)
- **后端**：Node.js (端口 3000)  
- **MCP 服务器**：Node.js (端口 3001)
- **进程管理**：Supervisor
- **数据库**：支持 SQLite 和 MySQL

## 测试验证
所有参数组合测试通过：
- ✅ 基本参数组合
- ✅ 端口参数组合  
- ✅ 模式参数组合
- ✅ 完整参数组合
- ✅ 部署参数组合
- ✅ 环境变量传递

## 总结
修复后的参数系统具有以下特点：
1. **完全正交**：所有参数可以任意组合
2. **向后兼容**：原有用法保持不变
3. **灵活配置**：支持多种部署模式和端口配置
4. **易于扩展**：新增参数不会影响现有功能

现在用户可以自由组合参数，系统会根据参数自动选择正确的配置和部署方式。
