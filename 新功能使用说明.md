# 年假计算系统 - 新功能使用说明

## 新增功能概述

基于用户需求，我们为年假计算系统增加了以下新功能：

1. **runLocal 模式** - 使用本地 SQLite 数据库运行系统
2. **端口控制** - 支持自定义前后端服务端口

## 功能详情

### 1. runLocal 模式 (SQLite 数据库)

#### 特点
- 使用 SQLite 文件数据库，无需单独的数据库容器
- 数据持久化通过 Docker 卷实现
- 启动更快，资源占用更少
- 适合本地开发和测试环境

#### 使用方法
```bash
# 使用 SQLite 模式运行
./run.sh --run-local

# 使用 SQLite 模式并自定义端口
./run.sh --run-local --backend-port 4000 --frontend-port 9000
```

#### 技术实现
- 后端数据库配置支持 MySQL 和 SQLite 双模式
- 根据 `DB_TYPE` 环境变量自动选择数据库类型
- 创建了专用的 `docker-compose.sqlite.yml` 文件
- 后端容器创建了 `/app/data` 目录用于存储 SQLite 数据库文件

### 2. 端口控制功能

#### 特点
- 支持自定义前端和后端服务端口
- 通过命令行参数灵活配置
- 与现有部署流程无缝集成

#### 使用方法
```bash
# 自定义后端端口
./run.sh --backend-port 4000

# 自定义前端端口  
./run.sh --frontend-port 9000

# 同时自定义前后端端口
./run.sh --backend-port 4000 --frontend-port 9000

# 结合 SQLite 模式使用
./run.sh --run-local --backend-port 4000 --frontend-port 9000
```

#### 技术实现
- 通过环境变量 `BACKEND_PORT` 和 `FRONTEND_PORT` 传递端口配置
- 更新了部署脚本以支持动态端口配置
- 健康检查和服务状态显示使用正确的端口

## 文件结构变更

### 新增文件
- `docker/docker-compose.sqlite.yml` - SQLite 专用的 Docker Compose 配置
- `docker/.env.sqlite` - SQLite 模式的环境变量配置
- `test_new_features.sh` - 新功能测试脚本

### 修改文件
- `run.sh` - 添加参数解析和端口控制功能
- `docker/deploy.sh` - 支持选择不同的 Docker Compose 文件和环境配置
- `backend/config/database.js` - 支持 SQLite 和 MySQL 双数据库模式
- `docker/backend/Dockerfile` - 添加数据目录用于 SQLite 数据库

## 使用示例

### 示例 1: 标准 MySQL 模式
```bash
# 使用默认配置（MySQL 数据库）
./run.sh
```

### 示例 2: SQLite 本地模式
```bash
# 使用 SQLite 数据库
./run.sh --run-local
```

### 示例 3: 自定义端口
```bash
# 使用自定义端口
./run.sh --backend-port 4000 --frontend-port 9000
```

### 示例 4: SQLite + 自定义端口
```bash
# 使用 SQLite 数据库和自定义端口
./run.sh --run-local --backend-port 4000 --frontend-port 9000
```

## 环境配置

### SQLite 模式环境变量
- `RUN_MODE=sqlite` - 运行模式标识
- `DB_TYPE=sqlite` - 数据库类型
- `SQLITE_DB_PATH=/app/data/annual_leave.db` - SQLite 数据库文件路径

### 端口配置环境变量
- `BACKEND_PORT=3000` - 后端服务端口（默认）
- `FRONTEND_PORT=8080` - 前端服务端口（默认）

## 注意事项

1. **数据持久化**: SQLite 模式的数据存储在 Docker 卷中，确保数据安全
2. **端口冲突**: 自定义端口时请确保端口未被其他服务占用
3. **环境配置**: 不同模式使用不同的环境变量文件，确保配置正确
4. **兼容性**: 新功能与现有功能完全兼容，不会影响现有部署

## 测试验证

所有新功能已通过测试验证：
- ✅ 参数解析功能正常
- ✅ 文件创建和配置正确
- ✅ 环境变量设置正确
- ✅ 与现有功能兼容

---

**创建时间**: 2025-10-08  
**最后更新**: 2025-10-08
