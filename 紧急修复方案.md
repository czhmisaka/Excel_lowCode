# 紧急修复方案 - 线上500错误

## 错误分析
线上环境出现以下错误：
- `Failed to load resource: the server responded with a status of 500 (Internal Server Error)`
- `获取表单列表失败`
- `初始化数据失败`

这些错误确认了我们的分析：**远程服务器缺少表单系统所需的数据库表**。

## 立即修复步骤

### 步骤1: 验证数据库表状态
在远程服务器上检查数据库表是否存在：

```bash
# 连接到SQLite数据库
sqlite3 ./data/annual_leave.db

# 检查表是否存在
.tables

# 检查form_definitions表
.schema form_definitions

# 退出
.quit
```

### 步骤2: 执行数据库初始化
如果表不存在，立即执行初始化：

```bash
# 进入应用目录
cd /path/to/application

# 执行数据库初始化脚本
node backend/scripts/initDatabase.js
```

### 步骤3: 验证修复结果
```bash
# 重新检查表
sqlite3 ./data/annual_leave.db
.tables

# 应该看到以下表：
# form_definitions
# form_hooks  
# form_submissions
# table_mappings
```

### 步骤4: 重启应用服务
```bash
# 重启Node.js应用（如果使用PM2）
pm2 restart app_name

# 或者直接重启
pkill -f node
npm start
```

## 临时解决方案

### 方案A: 禁用表单功能
如果无法立即修复数据库，可以临时禁用表单功能：

1. **修改前端代码**，移除表单管理相关的组件
2. **使用现有数据表功能**，直接使用Excel数据管理
3. **仅使用前端增强脚本**，不依赖后端表单系统

### 方案B: 使用现有表结构
修改代码使用现有的 `table_mappings` 表：

```javascript
// 临时修改：使用table_mappings表存储表单配置
// 在form_config字段中存储表单定义
```

## 验证修复

### 测试步骤
1. **访问健康检查**：`http://118.196.16.32:13000/health`
2. **测试表单接口**：`http://118.196.16.32:13000/api/forms`
3. **检查前端页面**：访问表单管理页面

### 预期结果
- 500错误消失
- 表单列表可以正常加载
- 前端不再报错

## 预防措施

### 1. 数据库迁移脚本
创建自动化的数据库迁移脚本：

```javascript
// backend/scripts/migrateDatabase.js
// 检查并创建缺失的表
```

### 2. 启动时自检
在应用启动时自动检查数据库表：

```javascript
// 在app.js中添加数据库表检查
async function checkDatabaseTables() {
  // 检查必要表是否存在
}
```

### 3. 错误处理改进
改进错误处理，提供更友好的错误信息：

```javascript
// 捕获数据库表缺失错误
try {
  // 数据库操作
} catch (error) {
  if (error.message.includes('no such table')) {
    console.error('数据库表缺失，请执行初始化脚本');
    // 提供修复指导
  }
}
```

## 紧急联系人

如果无法自行修复，请联系：
- **服务器管理员** - 数据库访问权限
- **开发团队** - 代码修改支持
- **运维团队** - 服务重启支持

## 时间预估

- **简单修复**（执行初始化脚本）：5-10分钟
- **复杂修复**（修改代码）：30-60分钟
- **验证测试**：10-15分钟

---
*紧急程度: 高*
*影响范围: 表单功能完全不可用*
*修复优先级: 立即处理*
